-- Drops das tabelas j√° criadas
DROP TABLE IF EXISTS livro CASCADE;
DROP TABLE IF EXISTS editora CASCADE;
DROP TABLE IF EXISTS autor CASCADE;
DROP TABLE IF EXISTS categoria CASCADE;
DROP TABLE IF EXISTS pessoa CASCADE;
DROP TABLE IF EXISTS status_loca CASCADE;
DROP TABLE IF EXISTS comentario CASCADE;
DROP TABLE IF EXISTS livro_pessoa_avalia CASCADE;
DROP TABLE IF EXISTS tipo_pessoa CASCADE;
DROP TABLE IF EXISTS livro_categoria CASCADE;
DROP TABLE IF EXISTS livro_autor CASCADE;
DROP TABLE IF EXISTS livro_pessoa_loca CASCADE;
DROP TABLE IF EXISTS livro_pessoa_fav CASCADE;

-- Creates das tabelas

CREATE TABLE EDITORA (
codigo_edit SERIAL PRIMARY KEY,
nome varchar(100)
);

CREATE TABLE AUTOR (
codigo_autor SERIAL PRIMARY KEY,
nome varchar(100),
nacionalidade varchar(100)
);

CREATE TABLE CATEGORIA (
dsc_categoria varchar(100),
codigo_categoria SERIAL PRIMARY KEY,
img_categoria text
);

CREATE TABLE LIVRO (
codigo_livro SERIAL PRIMARY KEY,
titulo varchar(100),
data_publicacao date,
ISBN bigint,
sinopse text,
edicao integer,
volume integer,
qtd_paginas integer,
img_capa text,
FK_EDITORA_codigo_edit INTEGER
);

CREATE TABLE LIVRO_AUTOR (
FK_LIVRO_codigo_livro INTEGER,
FK_AUTOR_codigo_autor INTEGER
);

CREATE TABLE LIVRO_CATEGORIA (
FK_CATEGORIA_codigo_categoria INTEGER,
FK_LIVRO_codigo_livro INTEGER
);

CREATE TABLE PESSOA (
codigo_pessoa SERIAL PRIMARY KEY,
nome varchar(150),
data_nasc date,
senha varchar(256),
email varchar(100),
username varchar(50),
img_perfil text,
FK_TIPO_PESSOA_codigo_tipo INTEGER
);

CREATE TABLE STATUS_LOCA (
codigo_status SERIAL PRIMARY KEY,
dsc_status varchar(50)
);

CREATE TABLE COMENTARIO (
codigo_comentario SERIAL PRIMARY KEY,
dsc_comentario varchar(500)
);

CREATE TABLE LIVRO_PESSOA_AVALIA (
FK_PESSOA_codigo_pessoa INTEGER,
FK_LIVRO_codigo_livro INTEGER,
FK_COMENTARIO_codigo_avaliacao_comentario INTEGER,
cod_avaliacao SERIAL PRIMARY KEY,
data date,
qtd_estrelas integer
);

CREATE TABLE TIPO_PESSOA (
codigo_tipo SERIAL PRIMARY KEY,
dsc_tipo varchar(50)
);

CREATE TABLE LIVRO_PESSOA_LOCA (
FK_STATUS_LOCA_codigo_status INTEGER,
FK_PESSOA_codigo_pessoa INTEGER,
FK_LIVRO_codigo_livro INTEGER,
codigo_locacao SERIAL PRIMARY KEY,
data_locacao date,
data_entrega date
);

CREATE TABLE LIVRO_PESSOA_FAV (
    FK_LIVRO_codigo_livro SERIAL,
    FK_PESSOA_codigo_pessoa SERIAL,
    codigo_favorito SERIAL PRIMARY KEY
);
 
ALTER TABLE LIVRO ADD CONSTRAINT FK_LIVRO_2
FOREIGN KEY (FK_EDITORA_codigo_edit)
REFERENCES EDITORA (codigo_edit)
ON DELETE RESTRICT;
 
ALTER TABLE PESSOA ADD CONSTRAINT FK_PESSOA_2
FOREIGN KEY (FK_TIPO_PESSOA_codigo_tipo)
REFERENCES TIPO_PESSOA (codigo_tipo)
ON DELETE CASCADE;
 
ALTER TABLE LIVRO_PESSOA_AVALIA ADD CONSTRAINT FK_LIVRO_PESSOA_AVALIA_2
FOREIGN KEY (FK_PESSOA_codigo_pessoa)
REFERENCES PESSOA (codigo_pessoa);
 
ALTER TABLE LIVRO_PESSOA_AVALIA ADD CONSTRAINT FK_LIVRO_PESSOA_AVALIA_3
FOREIGN KEY (FK_LIVRO_codigo_livro)
REFERENCES LIVRO (codigo_livro);
 
ALTER TABLE LIVRO_CATEGORIA ADD CONSTRAINT FK_LIVRO_CATEGORIA_1
FOREIGN KEY (FK_CATEGORIA_codigo_categoria)
REFERENCES CATEGORIA (codigo_categoria)
ON DELETE SET NULL;
 
ALTER TABLE LIVRO_CATEGORIA ADD CONSTRAINT FK_LIVRO_CATEGORIA_2
FOREIGN KEY (FK_LIVRO_codigo_livro)
REFERENCES LIVRO (codigo_livro)
ON DELETE SET NULL;
 
ALTER TABLE LIVRO_AUTOR ADD CONSTRAINT FK_LIVRO_AUTOR_1
FOREIGN KEY (FK_LIVRO_codigo_livro)
REFERENCES LIVRO (codigo_livro)
ON DELETE RESTRICT;
 
ALTER TABLE LIVRO_AUTOR ADD CONSTRAINT FK_LIVRO_AUTOR_2
FOREIGN KEY (FK_AUTOR_codigo_autor)
REFERENCES AUTOR (codigo_autor)
ON DELETE SET NULL;
 
ALTER TABLE LIVRO_PESSOA_LOCA ADD CONSTRAINT FK_LIVRO_PESSOA_LOCA_1
FOREIGN KEY (FK_LIVRO_codigo_livro)
REFERENCES LIVRO (codigo_livro)
ON DELETE NO ACTION;
 
ALTER TABLE LIVRO_PESSOA_LOCA ADD CONSTRAINT FK_LIVRO_PESSOA_LOCA_2
FOREIGN KEY (FK_STATUS_LOCA_codigo_status)
REFERENCES STATUS_LOCA (codigo_status)
ON DELETE NO ACTION;
 
ALTER TABLE LIVRO_PESSOA_LOCA ADD CONSTRAINT FK_LIVRO_PESSOA_LOCA_3
FOREIGN KEY (FK_PESSOA_codigo_pessoa)
REFERENCES PESSOA (codigo_pessoa)
ON DELETE NO ACTION;

ALTER TABLE LIVRO_PESSOA_AVALIA ADD CONSTRAINT FK_LIVRO_PESSOA_AVALIA_1
FOREIGN KEY(FK_COMENTARIO_codigo_avaliacao_comentario)
REFERENCES COMENTARIO(codigo_comentario)
ON DELETE SET NULL;

ALTER TABLE LIVRO_PESSOA_FAV ADD CONSTRAINT FK_LIVRO_PESSOA_FAV_1
    FOREIGN KEY (FK_LIVRO_codigo_livro)
    REFERENCES LIVRO (codigo_livro)
    ON DELETE SET NULL;
 
ALTER TABLE LIVRO_PESSOA_FAV ADD CONSTRAINT FK_LIVRO_PESSOA_FAV_2
    FOREIGN KEY (FK_PESSOA_codigo_pessoa)
    REFERENCES PESSOA (codigo_pessoa)
    ON DELETE SET NULL;